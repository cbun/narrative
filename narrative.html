<!DOCTYPE html>
<html>
    <head>

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

        <script src = 'http://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.3.1/jquery.cookie.min.js'></script>

        <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.0/js/bootstrap.min.js"></script>
        <!--<script src="../../../../Downloads/bootstrap 2/js/bootstrap.js"></script>-->
        <!--<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.0/css/bootstrap-combined.min.css" rel="stylesheet">-->
        <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.0/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
        <link href="http://netdna.bootstrapcdn.com/font-awesome/3.0.2/css/font-awesome.css" rel="stylesheet">

        <script src = './jquery/kbase/kbaseWidget.js'></script>
        <script src = './jquery/kbase/kbaseAuthenticatedWidget.js'></script>
        <script src = './jquery/kbase/kbasePrompt.js'></script>
        <script src = './jquery/kbase/kbaseDeletePrompt.js'></script>
        <script src = './jquery/kbase/kbaseErrorPrompt.js'></script>
        <script src = './jquery/kbase/kbaseLogin.js'></script>
        <script src = './jquery/kbase/kbaseAccordion.js'></script>
        <script src = './jquery/kbase/kbaseTabs.js'></script>
        <script src = './jquery/kbase/kbaseFormBuilder.js'></script>
        <script src = './jquery/kbase/kbaseBox.js'></script>

        <script src = './jquery/kbase/kbaseNarrativeWorkspace.js'></script>
        <script src = './jquery/kbase/kbaseNarrative.js'></script>
        <script src = './jquery/kbase/kbaseNarrativeBlock.js'></script>
        <script src = './jquery/kbase/kbaseNarrativeCommentBlock.js'></script>
        <script src = './jquery/kbase/kbaseNarrativeInvocationBlock.js'></script>
        <script src = './jquery/kbase/kbaseIrisCommands.js'></script>
        <script src = './jquery/kbase/kbaseFileBrowser.js'></script>
        <script src = './jquery/kbase/kbaseIrisFileBrowser.js'></script>
        <script src = './jquery/kbase/kbaseNarrativeDataBrowser.js'></script>

<!--        <script src = './js/kbase.js'></script>

        <script src = './jquery/kbase/jquery.kbase.widget.js'></script>

        <script src = './jquery/kbase/jquery.kbase.login.js'></script>
        <script src = './jquery/kbase/jquery.kbase.slidingPanel.js'></script>
        <script src = './jquery/kbase/jquery.kbase.formBuilder.js'></script>
        <script src = './jquery/kbase/jquery.kbaseNarrative.narrativeBlock.js'></script>
        <script src = './jquery/kbase/jquery.kbaseNarrative.javascriptBlock.js'></script>
        <script src = './jquery/kbase/jquery.kbaseNarrative.dataBlock.js'></script>
        <script src = './jquery/kbase/jquery.kbaseNarrative.comment.js'></script>
        <script src = './jquery/kbase/jquery.kbaseNarrative.narrative.js'></script>
        <script src = './jquery/kbase/jquery.kbaseNarrative.commandcontext.js'></script>
        <script src = './jquery/kbase/jquery.kbaseNarrative.dataUploader.js'></script>
-->

        <script src = './js/geometry/point.js'></script>
        <script src = './js/geometry/rectangle.js'></script>
        <script src = './js/geometry/size.js'></script>
        <script src = './js/RGBColor.js'></script>
<!--        <script src = './jquery/kbase/jquery.kbaseNarrative.animatedLineGraphBlock.js'></script>
        <script src = './jquery/kbase/jquery.kbaseNarrative.heatmapBlock.js'></script>
-->

<!--
        <script src = './jquery/kbase/jquery.kbaseIris.commands.js'></script>
        <script src = './jquery/kbase/jquery.kbaseNarrativeViz.commands.js'></script>
-->

<!--        <link type = 'text/css' href = 'http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.0/themes/smoothness/jquery-ui.css' rel = 'stylesheet' /> -->

        <script src = './js/MetaTool.js'></script>

        <script src="./js/InvocationService.js" type="text/javascript" charset="utf-8"></script>

		<script type="text/javascript">

            <!--

                function newWorkspaceCallback(files) {
                    try {
                        $.each(
                            files[0],
                            function (idx, val) {
                                $('#narrative_list').append(
                                    $('<option></option>')
                                        .attr('value', val.name)
                                        .append(val.name)
                                );
                            }
                        );
                    }
                    catch (e) {};

                    $('#add-workspace-dialog').dialog( "open" );
                }

                function getParameterByName(name)
                {
                  name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
                  var regexS = "[\\?&]" + name + "=([^&#]*)";
                  var regex = new RegExp(regexS);
                  var results = regex.exec(window.location.search);
                  if(results == null)
                    return "";
                  else
                    return decodeURIComponent(results[1].replace(/\+/g, " "));
                }

                $(function() {

                    /*$('#commandcontext').commandcontext(
                        {
                            link : function (evt) {
                                var f = $("#workspaces").data('addNarrativeCommand');
                                f($(this).text(), $(this).data('blockType'));
                            }
                        }
                    );*/

                    $('#addComment').bind('click', function (e) {
                        var $narrative = $('#tabs').kbaseNarrativeWorkspace('activeNarrative');
                        console.log('here we go');
                        console.log($narrative);
                        console.log('a1');
                        console.log('a2');
                        $narrative.addBlock( {type : 'comment'} );
                    });

                    window.$ld = $('#login').kbaseLogin(
                        {
                            style : 'text',
		                    login_callback : function(args) {
		                        if (this.session('user_id')) {
		                            var cookie = this.get_kbase_cookie();
		                            console.log("COOKIE");
		                            console.log(cookie.token);
                                    client.start_session_async(this.session('user_id'), function (res) {}, function (e){ console.log(e);} );
                                    //$('#uploader').dataUploader('listUploadedFiles');
                                }
		                    }
                        }
                    )

                    var client = new InvocationService('http://140.221.84.183:7049', undefined,
                        function() {
                            var cookie_obj = window.$ld.get_kbase_cookie();
                            if (cookie_obj) {
                                var token = cookie_obj['token'];
                                return token;
                            }
                            else {
                                return undefined;
                            }
                        }
                    );

                    $('#command-list').kbaseIrisCommands(
                        {
                            client          : client,
                            //connectToSortable : '.kb-nar-narrative',
                            englishCommands : true,
                            overflow        : true,
                            link : function (evt) {
                                evt.preventDefault();
                                evt.stopPropagation();
                                var $narrative = $('#tabs').kbaseNarrativeWorkspace('activeNarrative');
                                console.log("ADDS LINK");console.log($(this).data());console.log($(this));
                                $narrative.addBlock(
                                    {
                                        command : $(this).attr('title'),
                                        type    : $(this).data('type')
                                    }
                                );
                                /*var f = $("#workspaces").data('addNarrativeCommand');
                                f(
                                    $(this).attr('title'),
                                    $(this).data('blockType'),
                                    $(this).data('blockOptions')
                                );*/
                            }
                        }
                    );

                    var $fb = $('#file-browser').kbaseNarrativeDataBrowser (
                        {
                            client : client,
                            $loginbox : window.$ld,
                            externalControls : true,
                            root : '/narrative_data',
                            //controlButtons : ['viewButton', 'deleteButton', 'uploadButton' ],
                        }
                    );

                    var $tabs = $('#tabs').kbaseNarrativeWorkspace(
                        {
                            client      : client,
                            $loginbox   : window.$ld,
                            tabPosition : 'bottom',
                            canDelete   : true,
                        }
                    );

                    $tabs.addNarrative({name : 'shazbot'});

                    var $box = $('#box').kbaseBox(
                        {
                            title : 'This is a box',
                            content: 'Moo. We are a box.',
                            precontent : 'Before the box',
                            postcontent : 'after the box',
                            controls : [
                                {
                                    icon : 'icon-search',
                                     callback : function(e, $prompt) {
                                        console.log("clicked on search");
                                    },
                                    id : 'search',
                                },
                                {
                                    icon : 'icon-minus',
                                    callback : function(e, $prompt) {
                                        console.log("clicked on search");
                                    },
                                    id : 'minus',
                                },
                                {
                                    icon : 'icon-plus',
                                    callback : function(e, $prompt) {
                                        console.log("clicked on search");
                                    }
                                },

                            ],
                        }
                    );

                    $box.controls('minus').css('display', 'none');


//                    $tabs.listNarratives(function (files) {console.log(files)});

//                    $tabs.addTab('T1', $('<div></div>').html("I am a tab"));
//                    $tabs.addTab('T2', $('<div></div>').html("I am a tab 2"));
//                    $tabs.addTab('T3', $('<div></div>').html("I am a tab 3"));
//$tabs.showTab('T2');

                    $('#workspaces').data('addNarrativeCommand', function(label, blockType, blockOptions) {

                        if (label.length == 0) {
                            $('#add-custom-command-error').css('display', '');
                            return;
                        }

                        var $selectedPanel = $('#workspaces').data('selectedPanel');

                        var prompt = getParameterByName('version') == 'B'
                            ? 0
                            : 1;
                        //console.log("ADDS " + label + ' of ' + blockType);
                        $( $selectedPanel.children()[0] ).narrative('addBlock', { name : label, prompt : prompt, blockType: blockType, blockOptions : blockOptions });
                        $( $selectedPanel.children()[0] ).narrative('reposition');
                        //$(window).trigger('resize');

                        return 1;

                    });


                    /*$('#workspaces').tabs({
                        tabTemplate: "<li><a href='#{href}'>#{label}</a> <span class='ui-icon ui-icon-close removeTabButton'>Remove Tab</span></li>",

                        add: function( event, ui ) {

                            var name = $(ui.tab).text();
                            $(ui.panel).css('visibility', 'hidden');
                            var $narrative = $('<div></div>').narrative({name : name, client : client});

                            $(ui.panel).append( $narrative );
                            $narrative.narrative('reposition');
                            $(ui.panel).css('visibility', '');
                        },
                        show : function (event, ui) {
                            $(ui.panel).css('visibility', 'hidden');
                            $(this).data('selectedPanel', $(ui.panel));
                            $( $(ui.panel).children()[0] ).narrative('reposition');
                            $(ui.panel).css('visibility', '');

                        }
                    });

                    $( "#workspaces span.removeTabButton" ).live( "click", function() {

                        var index = $( "li", $('#workspaces') ).index( $( this ).parent() );
                        var selectedIndex = $('#workspaces').tabs('option', 'selected');

                        if (index == selectedIndex) {
                            if (index > 1) {
                                $('#workspaces').tabs('option', 'selected', index - 1);
                            }
                            else if (index == 1 && $('#workspaces').tabs("length") > 2) {
                                $('#workspaces').tabs('option', 'selected', index + 1);
                            }
                            else {
                                $('#workspaces').tabs('option', 'selected', 0);
                            }
                        }

                        $('#workspaces').tabs( "remove", index );

                    });

                    $('#add-tabs-button').bind('click', function(evt) {

                        if (window.$ld.login('session').user_id == undefined) {
                            return;
                        }

                        $('#narrative_list').empty();
                        $('#narrative_list').append(
                            $('<option></option>')
                                .attr('value', '')
                                .append('-----')
                        );

                        client.list_files_async(
                            window.$ld.login('session').user_id,
                            '/',
                            'narratives',
                            newWorkspaceCallback,
                            newWorkspaceCallback
                        );

                    });


                    $('#workspaces').bind('tabsselect', function(event, ui) {

                        if ($(ui.tab).attr('href') == '#add-workspace') {
                            $('#add-workspace-dialog').dialog( "open" );
                            return false;
                        }
                        else {
                            return true;
                        }
                    } );

                    var $add_workspace_dialog = $( "#add-workspace-dialog" ).dialog({
                        autoOpen    : false,
                        resizable   : false,
                        modal       : true,
                        buttons     : {
                            Cancel  : function() {
                                $( this ).dialog( "close" );
                            },
                            Add     : function() {
                                var f = $("#workspaces").data("addTab");

                                var title = $("#narrative_list").val() || $("#workspace_title").val();

                                var res = f(title);
                                if (res) {
                                    $( this ).dialog( "close" );
                                }
                                else {
                                    $("#workspace_title").focus();
                                }
                            },
                        },
                        open: function() {
                            $("#workspace_title").focus();
                        },
                        close: function() {
                            $('#add-workspace-error').css('display', 'none');
                            $('form', $(this))[0].reset();
                        }
                    });

                    $('#workspaces').data('workspace_idx', $("#workspaces").tabs("length"));

                    $('#workspaces').data('addTab', function(label) {

                        if (label.length == 0) {
                            $('#add-workspace-error').css('display', '');
                            return;
                        }
                        var workspace_idx = $('#workspaces').tabs("length");

                        var newIdx = $('#workspaces').tabs("length") ;

                        $("#workspaces").tabs("add", "#workspaces-" + workspace_idx, label, newIdx);
                        $("#workspaces").tabs("select", newIdx);

                        return 1;
                    });

                    // addTab form: calls addTab function on submit and closes the dialog
                    $( "form", $add_workspace_dialog ).submit(function() {
                        var f = $("#workspaces").data("addTab");
                        var res = f($("#workspace_title").val());
                        if (res) {
                            $add_workspace_dialog.dialog( "close" );
                        }
                        return false;
                    });

                    $('#add-comment').click(function(event) {

                        var $selectedPanel = $('#workspaces').data('selectedPanel');

                        if ($selectedPanel) {
                            $( $selectedPanel.children()[0] ).narrative('addComment');
                            //$(window).trigger('resize');
                            $( $selectedPanel.children()[0] ).narrative('reposition');
                        }
                    });



                    var $add_custom_command_dialog = $( "#add-custom-command-dialog" ).dialog({
                        autoOpen: false,
                        modal: true,
                        buttons: {
                            Cancel: function() {
                                $( this ).dialog( "close" );
                            },
                            Add: function() {
                                var f = $('#workspaces').data("addNarrativeCommand");
                                var res = f($("#command_title").val(), 'narrativeBlock');
                                if (res) {
                                    $( this ).dialog( "close" );
                                }
                                else {
                                    $("#command_title").focus();
                                }
                            }
                        },
                        open: function() {
                            $("#command_title").focus();
                        },
                        close: function() {
                            $('#add-custom-command-error').css('display', 'none');
                            $('form', $(this))[0].reset();
                        }
                    });

                    // addTab form: calls addTab function on submit and closes the dialog
                    $( "form", $add_custom_command_dialog ).submit(function() {
                        var f = $("#workspaces").data("addNarrativeCommand");
                        var res = f($("#command_title").val(), 'narrativeBlock');
                        if (res) {
                            $add_custom_command_dialog.dialog( "close" );
                        }
                        return false;
                    });

                    $('#add-custom-command').click(function(event) {
                        $add_custom_command_dialog.dialog( "open" );
                    });

                    $('#add-custom-command').button();
                    $('#add-comment').button();
*/
                });




			//-->
		</script>


        <title>KBase Narrative</title>
        <link rel="icon" href="img/KBase_favicon.ico" type="image/x-icon">
        <link href="css/identity.css" rel="stylesheet">
        <link href="css/kbase-common.css" rel="stylesheet">
        <link href="css/narrative.css" rel="stylesheet">
        <style type="text/css">
          body {
            /* padding to make room for the fixed nav bar,
               modify in css as needed. */
            padding-top: 60px;
          }
        </style>

    </head>

    <body>

        <div class="navbar navbar-fixed-top">
          <div class="navbar-inner">
            <a href="http://www.kbase.us/labs/"><img class="logo" src="img/labs_icon.png" width="46"></a>
            <a class="brand">Narrative</a>
            <ul class="nav" style="float:right;">
              <li id = 'login' style = 'padding : 9px 15px 7px 10px'></li>
            </ul>
          </div>
        </div>

        <div class = 'row-fluid'>
            <div class = 'span3'>
                <!--<img src = './img/kbase_logo.png'/ width = '220'><br/><br/>-->
                <div>
                    <button id = 'addComment' class = 'btn' style = 'width : 100%'>Add comment</button>
                </div>
                <div id = 'command-list'></div>
                <div id = 'process-list'></div>
                <div id = 'file-browser'></div>
            </div>
            <div class = 'span9' style = 'position : relative'>

                <div id = 'tabs'></div>
                <div id = 'box'></div>

            </div>
        </div>

        <br clear = 'all'/>


        <div id="pgfooter">Copyright &copy; 2012 DOE <a href = 'http://www.kbase.us/'>KBase</a></div>

    </body>



</html>

